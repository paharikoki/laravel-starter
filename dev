#!/bin/bash
# Laravel Docker Development - Modern Startup
set -e

echo "ğŸš€ Starting Laravel Development Environment..."

# Copy environment if needed
[ ! -f .env ] && cp .env.docker .env

# Start development services
echo "ğŸ“¦ Starting development services..."
docker-compose -f docker-compose.dev.yml up -d --build

# Wait for MySQL
echo "â³ Waiting for MySQL..."
until docker-compose -f docker-compose.dev.yml exec mysql mysqladmin ping -h"localhost" --silent 2>/dev/null; do
    sleep 2
done

# Install dependencies and setup
echo "ğŸ“‹ Installing dependencies..."
docker-compose -f docker-compose.dev.yml exec app composer install --no-interaction
docker-compose -f docker-compose.dev.yml exec app npm install

# Generate app key if needed
if ! grep -q "APP_KEY=base64:" .env; then
    echo "ğŸ”‘ Generating application key..."
    docker-compose -f docker-compose.dev.yml exec app php artisan key:generate --no-interaction
fi

# Run migrations
echo "ğŸ—„ï¸  Running migrations..."
docker-compose -f docker-compose.dev.yml exec app php artisan migrate --force

echo ""
echo "âœ… Development environment ready!"
echo "ğŸŒ App: http://localhost"
echo "ğŸ“§ Mailhog: http://localhost:8025"
echo ""
echo "ğŸ”§ Commands:"
echo "  npm run dev    # Start Vite hot reload"
echo "  npm run build  # Build for production"
echo "  make shell     # Access container"
echo "  make logs      # View logs"
echo "  make stop      # Stop services"